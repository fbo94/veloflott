#!/bin/bash
# Pre-commit hook for Laravel project
# Runs before git commit

echo "üöÄ Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get list of staged PHP files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep ".php\{0,1\}$")

if [ -z "$STAGED_FILES" ]; then
    echo "‚úÖ No PHP files to check"
    exit 0
fi

echo "üìÅ Checking staged files..."
echo "$STAGED_FILES" | while read -r file; do
    echo "  - $file"
done

# Flag to track if any check fails
CHECKS_FAILED=0

# ============================================
# 1. PHP Syntax Check
# ============================================
echo ""
echo "1Ô∏è‚É£  Checking PHP syntax..."

for FILE in $STAGED_FILES; do
    php -l -d display_errors=0 "$FILE"
    if [ $? != 0 ]; then
        echo -e "${RED}‚ùå PHP syntax error in: $FILE${NC}"
        CHECKS_FAILED=1
    fi
done

if [ $CHECKS_FAILED -eq 0 ]; then
    echo -e "${GREEN}‚úÖ PHP syntax check passed${NC}"
fi

# ============================================
# 2. Laravel Pint (Code Style)
# ============================================
echo ""
echo "2Ô∏è‚É£  Running Laravel Pint..."

if command -v ./vendor/bin/pint &> /dev/null; then
    ./vendor/bin/pint --test $STAGED_FILES

    if [ $? != 0 ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  Code style issues found. Running Pint to fix...${NC}"
        ./vendor/bin/pint $STAGED_FILES

        # Re-add fixed files
        echo "$STAGED_FILES" | xargs git add

        echo -e "${GREEN}‚úÖ Code style fixed and re-staged${NC}"
    else
        echo -e "${GREEN}‚úÖ Code style check passed${NC}"
    fi
else
    echo -e "${YELLOW}‚ö†Ô∏è  Laravel Pint not found, skipping...${NC}"
fi

# ============================================
# 3. PHPStan (Static Analysis)
# ============================================
echo ""
echo "3Ô∏è‚É£  Running PHPStan..."

if command -v ./vendor/bin/phpstan &> /dev/null; then
    ./vendor/bin/phpstan analyse --memory-limit=2G $STAGED_FILES

    if [ $? != 0 ]; then
        echo -e "${RED}‚ùå PHPStan found issues${NC}"
        CHECKS_FAILED=1
    else
        echo -e "${GREEN}‚úÖ PHPStan check passed${NC}"
    fi
else
    echo -e "${YELLOW}‚ö†Ô∏è  PHPStan not found, skipping...${NC}"
fi

# ============================================
# 4. Larastan (Laravel-specific Static Analysis)
# ============================================
echo ""
echo "4Ô∏è‚É£  Running Larastan..."

if command -v ./vendor/bin/phpstan &> /dev/null; then
    # Check if larastan config exists
    if [ -f "phpstan.neon" ] || [ -f "phpstan.neon.dist" ]; then
        ./vendor/bin/phpstan analyse --memory-limit=2G

        if [ $? != 0 ]; then
            echo -e "${RED}‚ùå Larastan found issues${NC}"
            CHECKS_FAILED=1
        else
            echo -e "${GREEN}‚úÖ Larastan check passed${NC}"
        fi
    fi
else
    echo -e "${YELLOW}‚ö†Ô∏è  Larastan not found, skipping...${NC}"
fi

# ============================================
# 5. Check for debugging statements
# ============================================
echo ""
echo "5Ô∏è‚É£  Checking for debugging statements..."

DEBUG_PATTERNS=(
    "\bdd\("
    "\bdump\("
    "\bvar_dump\("
    "\bprint_r\("
    "\bconsole\.log\("
    "\bdebug\("
    "\bray\("
)

for FILE in $STAGED_FILES; do
    for PATTERN in "${DEBUG_PATTERNS[@]}"; do
        # Skip if the match is part of a common PHP function
        if grep -q "$PATTERN" "$FILE" | grep -v -E "(array_diff|addslashes|addcslashes|array_push|array_pop)"; then
            echo -e "${RED}‚ùå Found debugging statement '$PATTERN' in: $FILE${NC}"
            CHECKS_FAILED=1
        fi
    done
done

if [ $CHECKS_FAILED -eq 0 ]; then
    echo -e "${GREEN}‚úÖ No debugging statements found${NC}"
fi

# ============================================
# 6. Check for TODO/FIXME with JIRA reference
# ============================================
echo ""
echo "6Ô∏è‚É£  Checking TODO/FIXME comments..."

for FILE in $STAGED_FILES; do
    # Check if TODO/FIXME exists without JIRA reference
    if grep -E "(TODO|FIXME)" "$FILE" | grep -v -E "TODO\(KOMUT-[0-9]+\)|FIXME\(KOMUT-[0-9]+\)"; then
        echo -e "${YELLOW}‚ö†Ô∏è  TODO/FIXME found without KOMUT reference in: $FILE${NC}"
        echo -e "${YELLOW}   Use format: TODO(KOMUT-123) or FIXME(KOMUT-123)${NC}"
        # Not failing, just warning
    fi
done

# ============================================
# 7. Check for .env changes
# ============================================
echo ""
echo "7Ô∏è‚É£  Checking for .env files..."

if echo "$STAGED_FILES" | grep -q "\.env"; then
    echo -e "${RED}‚ùå Attempting to commit .env file${NC}"
    echo -e "${RED}   Remove .env from staging: git reset HEAD .env${NC}"
    CHECKS_FAILED=1
else
    echo -e "${GREEN}‚úÖ No .env files in commit${NC}"
fi

# ============================================
# 8. Check migration files
# ============================================
echo ""
echo "8Ô∏è‚É£  Checking migration files..."

MIGRATION_FILES=$(echo "$STAGED_FILES" | grep "database/migrations/")

if [ ! -z "$MIGRATION_FILES" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Migration files detected:${NC}"
    echo "$MIGRATION_FILES"
    echo -e "${YELLOW}   Please ensure migrations are tested and reversible${NC}"

    # Check for down() method in migrations
    for FILE in $MIGRATION_FILES; do
        if ! grep -q "public function down()" "$FILE"; then
            echo -e "${RED}‚ùå Missing down() method in: $FILE${NC}"
            CHECKS_FAILED=1
        fi
    done
fi

# ============================================
# 9. Check file size
# ============================================
echo ""
echo "9Ô∏è‚É£  Checking file sizes..."

MAX_SIZE=500000 # 500KB

for FILE in $STAGED_FILES; do
    SIZE=$(wc -c < "$FILE")
    if [ $SIZE -gt $MAX_SIZE ]; then
        echo -e "${RED}‚ùå File too large: $FILE (${SIZE} bytes)${NC}"
        echo -e "${RED}   Maximum allowed: ${MAX_SIZE} bytes${NC}"
        CHECKS_FAILED=1
    fi
done

if [ $CHECKS_FAILED -eq 0 ]; then
    echo -e "${GREEN}‚úÖ File size check passed${NC}"
fi

# ============================================
# Final Result
# ============================================
echo ""
echo "================================"

if [ $CHECKS_FAILED -eq 1 ]; then
    echo -e "${RED}‚ùå Pre-commit checks FAILED${NC}"
    echo -e "${RED}   Please fix the issues above before committing${NC}"
    echo ""
    echo "To skip these checks (not recommended), use:"
    echo "  git commit --no-verify"
    exit 1
else
    echo -e "${GREEN}‚úÖ All pre-commit checks PASSED${NC}"
    echo -e "${GREEN}   Proceeding with commit...${NC}"
    exit 0
fi
