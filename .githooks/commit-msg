#!/bin/bash
# Commit message validation hook with JIRA Smart Commits support
# Format: type(scope): [VEL-ID] message

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

echo ""
echo "ğŸ“ Validating commit message..."

# Skip validation for merge commits
if [[ $COMMIT_MSG =~ ^Merge ]]; then
    echo -e "${BLUE}â„¹  Merge commit detected, skipping validation${NC}"
    exit 0
fi

# Valid commit types
VALID_TYPES="feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert"

# Regex pattern: type(scope): [VEL-ID] message
# Also supports JIRA Smart Commits:
#   chore(config): [VEL-237] added feature #comment Fixed the issue
#   fix(api): [VEL-456] resolve timeout #time 2h #comment Fixed
PATTERN="^(${VALID_TYPES})\([a-z0-9\-]+\): \[VEL-[0-9]+\] .{10,}"

# Check if message matches pattern
if [[ ! $COMMIT_MSG =~ $PATTERN ]]; then
    echo ""
    echo -e "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${RED}â•‘          âŒ INVALID COMMIT MESSAGE FORMAT âŒ                 â•‘${NC}"
    echo -e "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${YELLOW}ğŸ“‹ Required Format:${NC}"
    echo -e "   ${GREEN}type(scope): [VEL-ID] message${NC}"
    echo ""
    echo -e "${YELLOW}âœ… Valid Examples:${NC}"
    echo "   ${CYAN}Basic:${NC}"
    echo "   chore(config): [VEL-237] added pre-commit hook validation"
    echo "   feat(auth): [VEL-123] implement user authentication"
    echo "   fix(api): [VEL-456] resolve payment timeout issue"
    echo ""
    echo "   ${CYAN}With JIRA Smart Commits:${NC}"
    echo "   fix(api): [VEL-456] resolve timeout #comment Fixed the API timeout"
    echo "   feat(auth): [VEL-123] add login #time 3h #comment Implemented OAuth"
    echo "   fix(bug): [VEL-789] fix critical bug #close #comment Bug resolved"
    echo ""
    echo -e "${YELLOW}ğŸ“¦ Valid Types:${NC}"
    echo "   ${BLUE}feat${NC}     - New feature"
    echo "   ${BLUE}fix${NC}      - Bug fix"
    echo "   ${BLUE}docs${NC}     - Documentation changes"
    echo "   ${BLUE}style${NC}    - Code style/formatting"
    echo "   ${BLUE}refactor${NC} - Code refactoring"
    echo "   ${BLUE}test${NC}     - Adding or updating tests"
    echo "   ${BLUE}chore${NC}    - Maintenance tasks"
    echo "   ${BLUE}perf${NC}     - Performance improvements"
    echo "   ${BLUE}ci${NC}       - CI/CD changes"
    echo "   ${BLUE}build${NC}    - Build system changes"
    echo "   ${BLUE}revert${NC}   - Revert a previous commit"
    echo ""
    echo -e "${YELLOW}ğŸ« JIRA Smart Commits (Optional):${NC}"
    echo "   ${BLUE}#comment${NC} <text>      - Add comment to JIRA ticket"
    echo "   ${BLUE}#time${NC} <value>        - Log work time (e.g., 2h, 30m, 1d)"
    echo "   ${BLUE}#close${NC}               - Close/resolve the ticket"
    echo "   ${BLUE}#start${NC}               - Start work on ticket"
    echo "   ${BLUE}#stop${NC}                - Stop work on ticket"
    echo ""
    echo -e "${YELLOW}ğŸ“ Rules:${NC}"
    echo "   â€¢ Type must be lowercase"
    echo "   â€¢ Scope must be lowercase (letters, numbers, hyphens)"
    echo "   â€¢ Ticket ID format: [VEL-###]"
    echo "   â€¢ Message must be at least 10 characters"
    echo "   â€¢ Message should start with lowercase"
    echo "   â€¢ Message should NOT end with a period"
    echo ""
    echo -e "${RED}âŒ Your commit message:${NC}"
    echo "   ${COMMIT_MSG}"
    echo ""
    echo -e "${YELLOW}ğŸ’¡ Tip: To edit your commit message, use:${NC}"
    echo "   git commit --amend"
    echo ""
    exit 1
fi

# Extract JIRA ticket ID
TICKET_ID=$(echo "$COMMIT_MSG" | grep -oE 'VEL-[0-9]+')

# Check for JIRA Smart Commits
SMART_COMMANDS=$(echo "$COMMIT_MSG" | grep -oE '#(comment|time|close|start|stop|resolve)')

if [ ! -z "$SMART_COMMANDS" ]; then
    echo -e "${CYAN}ğŸ« JIRA Smart Commits detected:${NC}"
    echo "$SMART_COMMANDS" | while read -r cmd; do
        echo "   â€¢ $cmd"
    done
    echo ""
fi

# Validate Smart Commit syntax if present
if echo "$COMMIT_MSG" | grep -q "#time"; then
    TIME_VALUE=$(echo "$COMMIT_MSG" | grep -oE '#time [0-9]+[hdwm]')
    if [ -z "$TIME_VALUE" ]; then
        echo -e "${YELLOW}âš ï¸  Warning: #time format should be: #time 2h, #time 30m, #time 1d${NC}"
    else
        echo -e "${GREEN}âœ… Time logging: $TIME_VALUE${NC}"
    fi
fi

if echo "$COMMIT_MSG" | grep -q "#comment"; then
    COMMENT=$(echo "$COMMIT_MSG" | grep -oE '#comment .+' | sed 's/#comment //')
    if [ ${#COMMENT} -lt 5 ]; then
        echo -e "${YELLOW}âš ï¸  Warning: #comment text is too short${NC}"
    else
        echo -e "${GREEN}âœ… Will add comment to JIRA: ${COMMENT:0:50}...${NC}"
    fi
fi

# Extract message
MESSAGE=$(echo "$COMMIT_MSG" | sed -E 's/.*\[VEL-[0-9]+\] ([^#]+).*/\1/' | xargs)

# Check if message ends with period (warning only)
if [[ $MESSAGE =~ \.$]]; then
    echo -e "${YELLOW}âš ï¸  Warning: Commit message should not end with a period${NC}"
fi

# Check if message starts with uppercase (warning only)
if [[ $MESSAGE =~ ^[A-Z] ]]; then
    echo -e "${YELLOW}âš ï¸  Warning: Commit message should start with lowercase${NC}"
fi

echo -e "${GREEN}âœ… Commit message format is valid!${NC}"
echo -e "${CYAN}ğŸ“‹ JIRA Ticket: $TICKET_ID${NC}"
echo ""
exit 0
