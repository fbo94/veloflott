#!/bin/bash
# Pre-push hook for Laravel project
# Allow force pushes ONLY for interactive rebases

echo "üöÄ Running pre-push checks..."

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

CHECKS_FAILED=0
ALLOW_FORCE_PUSH=false  # By default, disallow force pushes

# ============================================
# 0. Detect a force push and verify it's an interactive rebase
# ============================================
if [[ "$*" =~ --force|--force-with-lease ]]; then
    echo ""
    echo "üî¥ Force push detected!"

    # Check if the last commit comes from an interactive rebase
    LAST_COMMIT_MSG=$(git log -1 --pretty=%B)
    if [[ "$LAST_COMMIT_MSG" =~ ^(pick|squash|fixup|edit|drop|reword) ]]; then
        echo -e "${GREEN}‚úÖ Rebase interactif d√©tect√© (force push autoris√©)${NC}"
        ALLOW_FORCE_PUSH=true
    else
        # Check if this is a protected branch
        BRANCH=$(git rev-parse --abbrev-ref HEAD)
        PROTECTED_BRANCHES=("main" "master" "develop" "production" "staging")

        if printf '%s\n' "${PROTECTED_BRANCHES[@]}" | grep -q "^$BRANCH$"; then
            echo -e "${RED}‚ùå Force push INTERDIT sur les branches prot√©g√©es ($BRANCH)${NC}"
            echo -e "${RED}   M√™me pour un rebase, utilisez une PR pour les branches sensibles${NC}"
            exit 1
        else
            echo -e "${RED}‚ùå Force push non autoris√© (pas un rebase interactif)${NC}"
            echo -e "${RED}   Utilisez 'git rebase -i' si vous voulez nettoyer l'historique${NC}"
            exit 1
        fi
    fi
fi

# ============================================
# 1. Run PHPUnit tests (Unit)
# ============================================
echo ""
echo "1Ô∏è‚É£  Running PHPUnit tests (Unit)..."

if command -v ./vendor/bin/phpunit &> /dev/null; then
    ./vendor/bin/phpunit --testsuite Unit --colors=never
    UNIT_TEST_EXIT_CODE=$?

    if [ $UNIT_TEST_EXIT_CODE -ne 0 ]; then
        echo -e "${RED}‚ùå Unit tests failed${NC}"
        CHECKS_FAILED=1
    else
        echo -e "${GREEN}‚úÖ Unit tests passed${NC}"
    fi
else
    echo -e "${YELLOW}‚ö†Ô∏è  PHPUnit not found, skipping...${NC}"
fi

# ============================================
# 2. Check for uncommitted changes (except for merges/rebases)
# ============================================
echo ""
echo "2Ô∏è‚É£  Checking for uncommitted changes..."

# Check whether the last commit is a merge (2 parents) or a rebase
LAST_COMMIT=$(git rev-parse HEAD)
if git cat-file -p "$LAST_COMMIT" | grep -q "^parent .*parent"; then
    echo -e "${GREEN}‚úÖ Merge commit detected (allowed)${NC}"
elif [[ "$LAST_COMMIT_MSG" =~ ^(pick|squash|fixup|edit|drop|reword) ]]; then
    echo -e "${GREEN}‚úÖ Rebase commit detected (allowed)${NC}"
elif ! git diff-index --quiet HEAD --; then
    echo -e "${RED}‚ùå You have uncommitted changes${NC}"
    git status --short
    CHECKS_FAILED=1
else
    echo -e "${GREEN}‚úÖ No uncommitted changes${NC}"
fi

# ============================================
# 3. Check branch name (block protected branches)
# ============================================
echo ""
echo "3Ô∏è‚É£  Checking branch name..."

BRANCH=$(git rev-parse --abbrev-ref HEAD)
PROTECTED_BRANCHES=("main" "master" "develop" "production" "staging")

if printf '%s\n' "${PROTECTED_BRANCHES[@]}" | grep -q "^$BRANCH$"; then
    echo -e "${RED}‚ùå Direct push to $BRANCH is not allowed${NC}"
    echo -e "${RED}   Please use a pull request${NC}"
    CHECKS_FAILED=1
else
    echo -e "${GREEN}‚úÖ Branch check passed${NC}"
fi

# ============================================
# 4. Verify the branch is up to date (except when force push is allowed)
# ============================================
if [ "$ALLOW_FORCE_PUSH" = false ]; then
    echo ""
    echo "4Ô∏è‚É£  Checking if branch is up to date..."

    git fetch origin > /dev/null 2>&1

    LOCAL=$(git rev-parse @)
    REMOTE=$(git rev-parse @{u} 2>/dev/null)
    BASE=$(git merge-base @ @{u} 2>/dev/null)

    if [ -z "$REMOTE" ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  No upstream branch set${NC}"
    elif [ "$LOCAL" = "$REMOTE" ]; then
        echo -e "${GREEN}‚úÖ Branch is up to date${NC}"
    elif [ "$LOCAL" = "$BASE" ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  Branch is behind remote${NC}"
        echo -e "${YELLOW}   Run: git pull --rebase${NC}"
        CHECKS_FAILED=1
    elif [ "$REMOTE" = "$BASE" ]; then
        echo -e "${GREEN}‚úÖ Branch is ahead of remote${NC}"
    else
        echo -e "${RED}‚ùå Branch has diverged${NC}"
        CHECKS_FAILED=1
    fi
fi

# ============================================
# 5. Security checks (Laravel)
# ============================================
echo ""
echo "5Ô∏è‚É£  Running security checks..."

if command -v ./vendor/bin/security-checker &> /dev/null; then
    ./vendor/bin/security-checker security:check composer.lock --format=summary

    if [ $? -ne 0 ]; then
        echo -e "${RED}‚ùå Security vulnerabilities found${NC}"
        CHECKS_FAILED=1
    else
        echo -e "${GREEN}‚úÖ No security vulnerabilities${NC}"
    fi
else
    echo -e "${YELLOW}‚ö†Ô∏è  Security checker not found${NC}"
    echo -e "${YELLOW}   Install: composer require --dev enlightn/security-checker${NC}"
fi

# ============================================
# 6. Check Laravel migrations (optional)
# ============================================
echo ""
echo "6Ô∏è‚É£  Checking Laravel migrations..."

if [ -d "database/migrations" ] && [ -f "artisan" ]; then
    PENDING_MIGRATIONS=$(php artisan migrate:status --no-ansi | grep "not migrated" | wc -l)

    if [ "$PENDING_MIGRATIONS" -gt 0 ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  $PENDING_MIGRATIONS pending migrations${NC}"
        echo -e "${YELLOW}   Run: php artisan migrate${NC}"
        # CHECKS_FAILED=1  # Uncomment to block pushes when there are pending migrations
    else
        echo -e "${GREEN}‚úÖ No pending migrations${NC}"
    fi
fi

# ============================================
# Final result
# ============================================
echo ""
echo "================================"

if [ $CHECKS_FAILED -eq 1 ]; then
    echo -e "${RED}‚ùå Pre-push checks FAILED${NC}"
    echo -e "${RED}   Please fix the issues above before pushing${NC}"
    echo ""
    echo "To skip these checks (not recommended), use:"
    echo "  git push --no-verify"
    exit 1
else
    echo -e "${GREEN}‚úÖ All pre-push checks PASSED${NC}"
    echo -e "${GREEN}   Proceeding with push...${NC}"
    exit 0
fi
